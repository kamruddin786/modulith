spring.application.name=modulith

spring.docker.compose.lifecycle-management=start-only

# Database Configuration
# Use environment variables for database connection in GKE
spring.datasource.url=${SPRING_DATASOURCE_URL:jdbc:postgresql://localhost:5432/mydatabase?timezone=UTC}
spring.datasource.username=${SPRING_DATASOURCE_USERNAME:myuser}
spring.datasource.password=${SPRING_DATASOURCE_PASSWORD:secret}
spring.datasource.driver-class-name=org.postgresql.Driver

# JPA/JDBC Configuration
spring.sql.init.mode=always
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=false
spring.data.jdbc.dialect=postgresql

# Spring Modulith Event Store Configuration
spring.modulith.events.jdbc.schema-initialization.enabled=false
spring.modulith.events.externalization.enabled=true
spring.modulith.events.jdbc.event-publication-table-name=event_publication
spring.main.allow-bean-definition-overriding=true

# Use custom table name via SQL customization
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.hibernate.naming.physical-strategy=org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl

# AMQP Configuration for RabbitMQ
spring.rabbitmq.host=${SPRING_RABBITMQ_HOST:localhost}
spring.rabbitmq.port=${SPRING_RABBITMQ_PORT:5672}
spring.rabbitmq.username=${SPRING_RABBITMQ_USERNAME:myuser}
spring.rabbitmq.password=${SPRING_RABBITMQ_PASSWORD:secret}
spring.rabbitmq.virtual-host=/

# Configure listener retries
spring.rabbitmq.listener.simple.retry.enabled=true
spring.rabbitmq.listener.simple.retry.initial-interval=1000
spring.rabbitmq.listener.simple.retry.max-attempts=3
spring.rabbitmq.listener.simple.retry.multiplier=1.5
spring.rabbitmq.listener.simple.default-requeue-rejected=true

# Event Publication Retry Configuration
spring.modulith.events.republish-outstanding-events-on-restart=true

# Connection pooling for better scalability
spring.rabbitmq.cache.channel.size=25
spring.rabbitmq.cache.connection.mode=channel

# Debug logging for Modulith and AMQP
logging.level.org.springframework.modulith=DEBUG
logging.level.org.springframework.amqp=DEBUG

# Connection validation for Spring Modulith
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.validation-timeout=5000
spring.datasource.hikari.connection-test-query=SELECT 1
spring.datasource.hikari.leak-detection-threshold=60000